<%-include("./partials/header.ejs")%>
<style>
  .clamp-lines {
    display: -webkit-box;
    -webkit-box-orient: vertical;
    overflow: hidden;
    -webkit-line-clamp: 2; /* Number of lines to show */
  }
</style>
  <body>
    <div class="mobile-header-active mobile-header-wrapper-style">
      <div class="mobile-header-wrapper-inner">
        <div class="mobile-header-top">
          <div class="mobile-header-logo">
            <!-- <a href="index.html"
              ><img
                src="../../public/userassets/imgs/theme/logo.svg"
                alt="logo"
            /></a> -->
          </div>
          <div
            class="mobile-menu-close close-style-wrap close-style-position-inherit"
          >
            <button class="close-style search-close">
              <i class="icon-top"></i>
              <i class="icon-bottom"></i>
            </button>
          </div>
        </div>
        <div class="mobile-header-content-area">
          <div class="mobile-search search-style-3 mobile-header-border">
            <form action="#">
              <input type="text" placeholder="Search for items…" />
              <button type="submit"><i class="fi-rs-search"></i></button>
            </form>
          </div>
          <div class="mobile-menu-wrap mobile-header-border">
            <div class="main-categori-wrap mobile-header-border">
              <a class="categori-button-active-2" href="#">
                <span class="fi-rs-apps"></span> Browse Categories
              </a>
              <div
                class="categori-dropdown-wrap categori-dropdown-active-small"
              >
                <ul>
                  <li>
                    <a href="shop-grid-right.html"
                      ><i class="evara-font-dress"></i>Women's Clothing</a
                    >
                  </li>
                  <li>
                    <a href="shop-grid-right.html"
                      ><i class="evara-font-tshirt"></i>Men's Clothing</a
                    >
                  </li>
                  <li>
                    <a href="shop-grid-right.html"
                      ><i class="evara-font-smartphone"></i> Cellphones</a
                    >
                  </li>
                  <li>
                    <a href="shop-grid-right.html"
                      ><i class="evara-font-desktop"></i>Computer & Office</a
                    >
                  </li>
                  <li>
                    <a href="shop-grid-right.html"
                      ><i class="evara-font-cpu"></i>Consumer Electronics</a
                    >
                  </li>
                  <li>
                    <a href="shop-grid-right.html"
                      ><i class="evara-font-home"></i>Home & Garden</a
                    >
                  </li>
                  <li>
                    <a href="shop-grid-right.html"
                      ><i class="evara-font-high-heels"></i>Shoes</a
                    >
                  </li>
                  <li>
                    <a href="shop-grid-right.html"
                      ><i class="evara-font-teddy-bear"></i>Mother & Kids</a
                    >
                  </li>
                  <li>
                    <a href="shop-grid-right.html"
                      ><i class="evara-font-kite"></i>Outdoor fun</a
                    >
                  </li>
                </ul>
              </div>
            </div>
            <!-- mobile menu start -->
            <nav>
              <ul class="mobile-menu">
                <li class="menu-item-has-children">
                  <span class="menu-expand"></span><a href="index.html">Home</a>
                  <ul class="dropdown">
                    <li><a href="index.html">Home 1</a></li>
                    <li><a href="index-2.html">Home 2</a></li>
                    <li><a href="index-3.html">Home 3</a></li>
                    <li><a href="index-4.html">Home 4</a></li>
                  </ul>
                </li>
                <li class="menu-item-has-children">
                  <span class="menu-expand"></span
                  ><a href="shop-grid-right.html">shop</a>
                  <ul class="dropdown">
                    <li>
                      <a href="shop-grid-right.html"
                        >Shop Grid – Right Sidebar</a
                      >
                    </li>
                    <li>
                      <a href="shop-grid-left.html">Shop Grid – Left Sidebar</a>
                    </li>
                    <li>
                      <a href="shop-list-right.html"
                        >Shop List – Right Sidebar</a
                      >
                    </li>
                    <li>
                      <a href="shop-list-left.html">Shop List – Left Sidebar</a>
                    </li>
                    <li><a href="shop-fullwidth.html">Shop - Wide</a></li>
                    <li class="menu-item-has-children">
                      <span class="menu-expand"></span
                      ><a href="#">Single Product</a>
                      <ul class="dropdown">
                        <li>
                          <a href="shop-product-right.html"
                            >Product – Right Sidebar</a
                          >
                        </li>
                        <li>
                          <a href="shop-product-left.html"
                            >Product – Left Sidebar</a
                          >
                        </li>
                        <li>
                          <a href="shop-product-full.html"
                            >Product – No sidebar</a
                          >
                        </li>
                      </ul>
                    </li>
                    <li><a href="shop-filter.html">Shop – Filter</a></li>
                    <li><a href="shop-wishlist.html">Shop – Wishlist</a></li>
                    <li><a href="shop-cart.html">Shop – Cart</a></li>
                    <li><a href="shop-checkout.html">Shop – Checkout</a></li>
                    <li><a href="shop-compare.html">Shop – Compare</a></li>
                  </ul>
                </li>
                <li class="menu-item-has-children">
                  <span class="menu-expand"></span><a href="#">Mega menu</a>
                  <ul class="dropdown">
                    <li class="menu-item-has-children">
                      <span class="menu-expand"></span
                      ><a href="#">Women's Fashion</a>
                      <ul class="dropdown">
                        <li><a href="shop-product-right.html">Dresses</a></li>
                        <li>
                          <a href="shop-product-right.html">Blouses & Shirts</a>
                        </li>
                        <li>
                          <a href="shop-product-right.html"
                            >Hoodies & Sweatshirts</a
                          >
                        </li>
                        <li>
                          <a href="shop-product-right.html">Women's Sets</a>
                        </li>
                      </ul>
                    </li>
                    <li class="menu-item-has-children">
                      <span class="menu-expand"></span
                      ><a href="#">Men's Fashion</a>
                      <ul class="dropdown">
                        <li><a href="shop-product-right.html">Jackets</a></li>
                        <li>
                          <a href="shop-product-right.html"
                            >Casual Faux Leather</a
                          >
                        </li>
                        <li>
                          <a href="shop-product-right.html">Genuine Leather</a>
                        </li>
                      </ul>
                    </li>
                    <li class="menu-item-has-children">
                      <span class="menu-expand"></span
                      ><a href="#">Technology</a>
                      <ul class="dropdown">
                        <li>
                          <a href="shop-product-right.html">Gaming Laptops</a>
                        </li>
                        <li>
                          <a href="shop-product-right.html"
                            >Ultraslim Laptops</a
                          >
                        </li>
                        <li><a href="shop-product-right.html">Tablets</a></li>
                        <li>
                          <a href="shop-product-right.html"
                            >Laptop Accessories</a
                          >
                        </li>
                        <li>
                          <a href="shop-product-right.html"
                            >Tablet Accessories</a
                          >
                        </li>
                      </ul>
                    </li>
                  </ul>
                </li>
                <li class="menu-item-has-children">
                  <span class="menu-expand"></span
                  ><a href="blog-category-fullwidth.html">Blog</a>
                  <ul class="dropdown">
                    <li>
                      <a href="blog-category-grid.html">Blog Category Grid</a>
                    </li>
                    <li>
                      <a href="blog-category-list.html">Blog Category List</a>
                    </li>
                    <li>
                      <a href="blog-category-big.html">Blog Category Big</a>
                    </li>
                    <li>
                      <a href="blog-category-fullwidth.html"
                        >Blog Category Wide</a
                      >
                    </li>
                    <li class="menu-item-has-children">
                      <span class="menu-expand"></span
                      ><a href="#">Single Product Layout</a>
                      <ul class="dropdown">
                        <li><a href="blog-post-left.html">Left Sidebar</a></li>
                        <li>
                          <a href="blog-post-right.html">Right Sidebar</a>
                        </li>
                        <li>
                          <a href="blog-post-fullwidth.html">No Sidebar</a>
                        </li>
                      </ul>
                    </li>
                  </ul>
                </li>
                <li class="menu-item-has-children">
                  <span class="menu-expand"></span><a href="#">Pages</a>
                  <ul class="dropdown">
                    <li><a href="page-about.html">About Us</a></li>
                    <li><a href="page-contact.html">Contact</a></li>
                    <li><a href="page-account.html">My Account</a></li>
                    <li>
                      <a href="page-login-register.html">login/register</a>
                    </li>
                    <li>
                      <a href="page-purchase-guide.html">Purchase Guide</a>
                    </li>
                    <li>
                      <a href="page-privacy-policy.html">Privacy Policy</a>
                    </li>
                    <li><a href="page-terms.html">Terms of Service</a></li>
                    <li><a href="page-404.html">404 Page</a></li>
                  </ul>
                </li>
                <li class="menu-item-has-children">
                  <span class="menu-expand"></span><a href="#">Language</a>
                  <ul class="dropdown">
                    <li><a href="#">English</a></li>
                    <li><a href="#">French</a></li>
                    <li><a href="#">German</a></li>
                    <li><a href="#">Spanish</a></li>
                  </ul>
                </li>
              </ul>
            </nav>
            <!-- mobile menu end -->
          </div>
          <div class="mobile-header-info-wrap mobile-header-border">
            <div class="single-mobile-header-info mt-30">
              <a href="page-contact.html"> Our location </a>
            </div>
            <div class="single-mobile-header-info">
              <a href="page-login-register.html">Log In / Sign Up </a>
            </div>
            <div class="single-mobile-header-info">
              <a href="#">(+01) - 2345 - 6789 </a>
            </div>
          </div>
          <!-- <div class="mobile-social-icon">
            <h5 class="mb-15 text-grey-4">Follow Us</h5>
            <a href="#"
              ><img
                src="../../public/userassets/imgs/theme/icons/icon-facebook.svg"
                alt=""
            /></a>
            <a href="#"
              ><img
                src="../../public/userassets/imgs/theme/icons/icon-twitter.svg"
                alt=""
            /></a>
            <a href="#"
              ><img
                src="../../public/userassets/imgs/theme/icons/icon-instagram.svg"
                alt=""
            /></a>
            <a href="#"
              ><img
                src="../../public/userassets/imgs/theme/icons/icon-pinterest.svg"
                alt=""
            /></a>
            <a href="#"
              ><img
                src="../../public/userassets/imgs/theme/icons/icon-youtube.svg"
                alt=""
            /></a>
          </div> -->
        </div>
      </div>
    </div>
    <main class="main">
      <div class="page-header breadcrumb-wrap">
        <div class="container">
          <div class="breadcrumb">
            <a href="index.html" rel="nofollow">Home</a>
            <span></span> Shop <span></span> Your Cart
          </div>
        </div>
      </div>
      <section class="mt-50 mb-50">
        <div class="container">
          <div class="row">
            <div class="col-12">
              <div class="table-responsive">
                <table class="table shopping-summery text-center clean">
                  <% if(products && !grandTotal == 0){ %>
                    <thead>
                      <tr class="main-heading">
                        <th scope="col">Image</th>
                        <th scope="col">Name</th>
                        <th scope="col">Price</th>
                        <th scope="col">Quantity</th>
                        <th scope="col">Subtotal</th>
                        <th scope="col">Remove</th>
                      </tr>
                    </thead>
                  <tbody>
                    <% products.products.forEach(product => { %>
                    <tr class="singleRow">
                      <td class="image product-thumbnail col-1">
                        <img
                          src="<%= product.productId.images[0].path%>"
                          alt="product image"
                        />
                      </td>
                      <td class="product-des product-name col-5">
                        <h5 class="product-name">
                          
                            <%= product.productId.brand%>
                        </h5>
                        <p class="font-xs">
                          
                        </p>
                        <p class="clamp-lines font-xs mr-50 ml-50">
                          <a href="/user/product-details/<%= product.productId._id%>"><%= product.productId.description%></a>
                        </p>
                        
                      </td>
                      <td class="prices" data-title="Price col-2">
                        <span>₹<%= product.productId.salesPrice%> </span>
                      </td>
                      <td class="text-center col-2" data-title="Stock">
                        <% if(product.productId.stock <= product.quantity){ %>
                          <div class="detail-qty border radius m-auto mt-20" data-product-id="<%= product._id %>">
                            <a href="" class="qty-up"><i class="fi-rs-angle-small-up"></i></a>
                            <span class="qty-val"><%= Number(product.quantity) %></span>
                            <a href="" class="qty-down"><i class="fi-rs-angle-small-down"></i></a>
                          </div>
                          <span class="text-danger">Out of Stock</span>
                          
                          <%} else {%>
                        <div class="detail-qty border radius m-auto mt-20" data-product-id="<%= product._id %>">
                          <a href="" class="qty-up"><i class="fi-rs-angle-small-up"></i></a>
                          <span class="qty-val"><%= Number(product.quantity) %></span>
                          <a href="" class="qty-down"><i class="fi-rs-angle-small-down"></i></a>
                        </div>
                        <div class="mt-5 text-secondary"><%=product.productId.stock - product.quantity %>  Products left</div>
                        <% } %>
                      </td>
                      <td class="text-right col-1" data-title="Cart">
                        <span class="cart-total">₹<%= product.productId.salesPrice * product.quantity %></span>
                      </td>
                      <td class="action col-1" data-title="Remove">
                        <a href="/user/delete-cart?userId=<%=product._id%>" class="btn btn-sm deleleCartBtn">
                          <i class="fi-rs-trash"></i>
                        </a>
                        
                      </td>
                    </tr>
                    <% }) %>
                    
                    <tr>
                      <td colspan="6" class="text-end">
                        <a href="/user/clear-all-cart" class="btn btn-sm">
                          <i class="fi-rs-cross-small"></i> Clear Cart</a
                          >
                        </td>
                      </tr>
                    <% } else{  %>
                      <tbody>
                        <tr>
                          <td colspan="6" class="text-center text-info">
                            Cart is empty
                          </td>
                        </tr>
                      </tbody>
                      <% }%>
                  </tbody>
                </table>
              </div>
              
                
              <div class="cart-action text-end">
                <!-- <a class="btn mr-10 mb-sm-15"
                  ><i class="fi-rs-shuffle mr-10"></i>Update Cart</a
                > -->
                <a class="btn" href="/user/"
                  ><i class="fi-rs-shopping-bag mr-10"></i>Continue Shopping</a
                >
              </div>
              <div class="divider center_icon mt-50 mb-50">
                <i class="fi-rs-fingerprint"></i>
              </div>
             <div class="d-flex align-items-center justify-content-center">
                <div class="col-lg-8 col-md-12  ">
                  <div class="border p-md-4 p-30 border-radius cart-totals ">
                    <div class="heading_s1 mb-3 d-flex justify-content-center">
                      <h4>Cart Totals</h4>
                    </div>
                    <div class="table-responsive">
                      <table class="table">
                        <tbody>
                          <!-- <tr>
                            <td class="cart_total_label">Cart Subtotal</td>
                            <td class="cart_total_amount">
                              <span class="font-lg fw-900 text-brand"
                                >$240.00</span
                              >
                            </td>
                          </tr> -->
                          <tr>
                            <td class="cart_total_label text-center">Shipping</td>
                            <td class="cart_total_amount text-center">
                              <i class="ti-gift mr-5"></i> Free Shipping
                            </td>
                          </tr>
                          <tr>
                            <td class="cart_total_label text-center">Total</td>
                            <td class="cart_total_amount">
                              <strong class="text-center">
                                <%if(grandTotal){%>
                                <div class="d-flex align-items-center justify-content-center">
                                  <span class="font-xl fw-900 text-brand text-center">₹<%=grandTotal%></span>
                                </div>
                                <%}else{%>
                                  <div class="d-flex align-items-center justify-content-center">
                                    <span class="font-xl fw-900 text-brand text-center">₹0</span>
                                  </div>
                                  <%}%>
                              </strong>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                    <div class="d-flex align-items-center justify-content-center"><a href="/user/checkout?grandTotal=<%=grandTotal%>" class="btn">
                      <i class="fi-rs-box-alt mr-10"></i> Proceed To CheckOut</a
                    ></div>
                    
                  </div>
                </div>
              </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
    <script>
      document.addEventListener("DOMContentLoaded",()=>{
          const quantityBtn = document.querySelectorAll(".detail-qty")
          
          quantityBtn.forEach((qunty) => {
            const qtyUp = qunty.querySelector(".qty-up")
            const qtyDown = qunty.querySelector(".qty-down")
            const qtyValue = qunty.querySelector(".qty-val")
            
            const productId = qunty.getAttribute("data-product-id")

            qtyUp.addEventListener("click" ,async (event) => {
              event.preventDefault()
              let newQuantity = parseInt(qtyValue.textContent,10) + 1;
              qtyValue.textContent = newQuantity
              console.log(newQuantity);
              await fetch("/user/update-quantity",{
                method:"POST",
                headers:{
                  'Content-Type': 'application/json'
                },body: 
                JSON.stringify(
                  {quantity:newQuantity, productId:productId}
                  )
              })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  qtyValue.textContent = data.quantity;
                }
                window.location.href = "/user/load-cart"
              }).catch(error => {
                  console.log("Error updating quantity:", error);
              })
            });

              // key down press event

            qtyDown.addEventListener("click",async(event) => {
                event.preventDefault()
                newQuantity = parseInt(qtyValue.textContent,10) - 1;
                if(newQuantity <= 1){
                  newQuantity = 1
                }
                qtyValue.textContent = newQuantity
                await fetch("/user/update-quantity",{
                method:"POST",
                headers:{
                  'Content-Type': 'application/json'
                },body: 
                JSON.stringify(
                  {quantity:newQuantity, productId:productId}
                  )
              })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  qtyValue.textContent = data.quantity;
                }
                window.location.href = "/user/load-cart"
              }).catch(error => {
                  console.log("Error updating quantity:", error);
              });

              })

          })
       

        const qtyUpBtn = document.querySelector(".qty-up")
        const qtyDownBtn = document.querySelector(".qty-down")
        const cartTotal = document.querySelector(".cart-total")
        const productPrices = document.querySelectorAll(".prices")
        const initialPrices = Array.from(productPrices).map(price => Number(price.textContent))
        const initialQuantities = Array.from(document.querySelectorAll(".qty-val")).map((qty) => Number(qty.textContent))
          
          qtyUpBtn.forEach((button , index) => {
            button.addEventListener("click",() => {
              const qtyVal = Number(initialQuantities[index]);
              const newQty = qtyVal + 1;
              initialQuantities[index] = newQty

              const newTotal = initialPrices[index] * newQty
              cartTotal[index].textContent = newTotal

            })
          })

          qtyDownBtn.forEach((button ,index) => {
            const qtyVal = Number(initialQuantities[index]);
            if(qtyVal > 1){
              const newQty = qtyVal-1
              initialQuantities[index] = newQty;
              const newTotal = initialPrices[index] * newQty;
              cartTotal[index].textContent = newTotal
            }
          })
      })

          </script>
      
    <%-include("./partials/footer.ejs")%>
  </body>
</html>
